<!DOCTYPE html>
<html>

<head>
    <title>OAuth Connector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        input,
        button {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        input {
            width: 300px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .connection {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }

        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .auth-link {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            word-break: break-all;
        }

        .token {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px;
            border: 1px solid #ddd;
            margin: 5px 0;
            word-break: break-all;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>OAuth Connector</h1>
    <input id="host" placeholder="OAuth Server (auth.example.com)">
    <button onclick="connect()">Connect</button>
    <div id="status"></div>
    <div id="connections"></div>
    <h3>Log</h3>
    <button onclick="clearLog()">Clear</button>
    <div id="log" class="log"></div>

    <script>
        const REDIRECT = 'https://connect.simplerauth.com';

        onload = () => { handleCallback(); renderConnections(); };

        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function connect() {
            const host = document.getElementById('host').value.trim();
            if (!host) return status('Enter hostname');

            try {
                log(`Connecting to ${host}...`);
                status('Fetching metadata...');

                const metaUrl = `https://${host}/.well-known/oauth-authorization-server`;
                const meta = await fetch(metaUrl).then(r => r.json());
                log('Got server metadata');

                // we're using post if client_secret was provided after registration
                const token_endpoint_auth_method = !meta?.token_endpoint_auth_methods_supported ? "client_secret_post" : meta?.token_endpoint_auth_methods_supported?.find(method => method === "none") ? "none" : meta?.token_endpoint_auth_methods_supported?.find(method => method === "client_secret_post") ? "client_secret_post" : undefined;

                status('Registering client...');
                const client = await fetch(meta.registration_endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        redirect_uris: [REDIRECT],
                        client_name: 'OAuth Connector',
                        grant_types: ['authorization_code'],
                        token_endpoint_auth_method,
                        response_types: ['code']
                    })
                }).then(r => r.json());
                log('Client registered');

                const state = Math.random().toString(36).substr(2);
                const scope = meta.scopes_supported ? meta.scopes_supported.join(' ') : 'openid profile';
                const authUrl = `${meta.authorization_endpoint}?${new URLSearchParams({
                    response_type: 'code',
                    client_id: client.client_id,
                    redirect_uri: REDIRECT,
                    state: state,
                    scope: scope
                })}`;

                localStorage.setItem(`oauth_state_${state}`, JSON.stringify({ client, meta, state }));

                log(`Auth URL: `);
                const logEl = document.getElementById('log');
                const link = document.createElement('span');
                link.className = 'auth-link';
                link.textContent = authUrl;
                link.onclick = () => window.open(authUrl, '_blank');
                logEl.appendChild(link);
                logEl.appendChild(document.createTextNode('\n'));

                status('Click auth URL in log');

            } catch (e) {
                log(`Error: ${e.message}`);
                status('Failed');
            }
        }

        async function handleCallback() {
            const params = new URLSearchParams(location.search);
            const code = params.get('code'), state = params.get('state');
            if (!code) return;

            log('Processing callback...');

            const data = JSON.parse(localStorage.getItem(`oauth_state_${state}`) || '{}');
            if (!data.state) return status('Invalid state');

            try {
                const tokenBody = new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT,
                    client_id: data.client.client_id
                });

                if (data.client.client_secret) {
                    tokenBody.append('client_secret', data.client.client_secret);
                }

                const token = await fetch(data.meta.token_endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: tokenBody
                }).then(r => r.json());

                const connections = JSON.parse(localStorage.oauth_connections || '{}');
                const hostname = new URL(data.meta.issuer).hostname;
                connections[hostname] = {
                    access_token: token.access_token,
                    issuer: data.meta.issuer,
                    expires: token.expires_in ? Date.now() + token.expires_in * 1000 : null,
                    client_secret: data.client.client_secret || null
                };

                localStorage.oauth_connections = JSON.stringify(connections);
                localStorage.removeItem(`oauth_state_${state}`);

                log(`Connected to ${hostname}`);
                history.replaceState({}, '', location.pathname);
                status('Connected');
                renderConnections();

            } catch (e) {
                log(`Token error: ${e.message}`);
                status('Token failed');
            }
        }

        function renderConnections() {
            const connections = JSON.parse(localStorage.oauth_connections || '{}');
            const connectionsEl = document.getElementById('connections');

            if (Object.keys(connections).length === 0) {
                connectionsEl.innerHTML = '<p>No connections</p>';
                return;
            }

            connectionsEl.innerHTML = Object.entries(connections).map(([host, info]) => {
                const tokenId = `token_${host.replace(/\./g, '_')}`;
                return `<div class="connection">
                    <h4>${host}</h4>
                    <p>Issuer: ${info.issuer}</p>
                    <p>Expires: ${info.expires ? new Date(info.expires).toLocaleString() : 'Unknown'}</p>
                    ${info.client_secret ? `<p>Client Secret: ${info.client_secret}</p>` : ''}
                    <button onclick="document.getElementById('${tokenId}').classList.toggle('hidden')">Toggle Token</button>
                    <div id="${tokenId}" class="token hidden">${info.access_token}</div>
                    <button onclick="logout('${host}')">Logout</button>
                </div>`;
            }).join('');
        }

        function logout(host) {
            const connections = JSON.parse(localStorage.oauth_connections || '{}');
            delete connections[host];
            localStorage.oauth_connections = JSON.stringify(connections);
            renderConnections();
            log(`Logged out from ${host}`);
        }

        function status(msg) {
            document.getElementById('status').textContent = msg;
            if (msg !== 'Connected') setTimeout(() => document.getElementById('status').textContent = '', 3000);
        }
    </script>
</body>

</html>