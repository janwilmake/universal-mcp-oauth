<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parallel Tasks with MCP tools</title>
    <link rel="icon" type="image/svg+xml" href="https://assets.p0web.com/dark-parallel-symbol-270.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Regular.woff2') format('woff2');
            font-weight: 400;
        }

        @font-face {
            font-family: 'FT System Mono';
            src: url('https://assets.p0web.com/FTSystemMono-Medium.woff2') format('woff2');
            font-weight: 500;
        }

        @font-face {
            font-family: 'Gerstner Programm';
            src: url('https://assets.p0web.com/Gerstner-ProgrammRegular.woff2') format('woff2');
            font-weight: 400;
        }

        @font-face {
            font-family: 'Gerstner Programm';
            src: url('https://assets.p0web.com/Gerstner-ProgrammMedium.woff2') format('woff2');
            font-weight: 500;
        }

        body {
            font-family: 'FT System Mono', 'Courier New', monospace;
        }

        .font-gerstner {
            font-family: 'Gerstner Programm', 'FT System Mono', monospace;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        'parallel-off-white': '#fcfcfa',
                        'parallel-black': '#1d1b16',
                        'parallel-neural': '#d8d0bf',
                        'parallel-signal': '#fb631b',
                    }
                }
            }
        }
    </script>
</head>

<body
    class="bg-parallel-off-white dark:bg-parallel-black text-parallel-black dark:text-parallel-off-white min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Header -->
        <div
            class="text-center bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
            <div class="flex items-center justify-center gap-3 mb-3">
                <picture>
                    <source media="(prefers-color-scheme: dark)"
                        srcset="https://assets.p0web.com/white-parallel-symbol-270.svg">
                    <img src="https://assets.p0web.com/dark-parallel-symbol-270.svg" alt="Parallel Logo" class="h-8">
                </picture>
                <h1 class="font-gerstner text-2xl font-medium">
                    <span class="text-parallel-signal">parallel</span> with MCP
                </h1>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm">
                Tasks with MCP tools - Authenticate with MCP servers and execute tasks with powerful toolcalling
            </p>
        </div>

        <div id="content">
            <div
                class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 text-center">
                <p>Please <a href="/authorize?redirect_to=/"
                        class="text-parallel-signal hover:underline font-medium">authenticate with X</a>
                    to manage your MCP server connections</p>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');

        const usefulMCPs = [
            { name: "Linear", url: "https://mcp.linear.app/mcp", description: "Task management and issue tracking" },
            { name: "Notion", url: "https://mcp.notion.com/mcp", description: "Document and workspace management" },
            { name: "Prisma Postgres", url: "https://mcp.prisma.io/mcp", description: "Database schema management and queries" },
            { name: "Context7 (Smithery.ai)", url: "https://server.smithery.ai/@upstash/context7-mcp/mcp", description: "Find docs for libraries" },
            { name: "Hugging Face", url: "https://hf.co/mcp", description: "AI models, datasets, and ML tools" },
            { name: "Exa", url: "https://mcp.exa.ai/mcp?exaApiKey=your-exa-api-key", description: "Vector Search" },
            { name: "Reddit (agentic.so)", url: "https://gateway.agentic.so/@agentic/reddit/mcp", description: "Get threads content on Reddit" }
        ];

        function addMCPServer() {
            const url = document.getElementById('mcpUrl').value.trim();
            if (!url) {
                showError('Please enter a valid MCP server URL');
                return;
            }

            try {
                new URL(url);
                window.location.href = `/mcp/login?url=${encodeURIComponent(url)}`;
            } catch (e) {
                showError('Please enter a valid URL');
            }
        }

        function removeMCPServer(mcpUrl) {
            if (confirm(`Remove connection to "${mcpUrl}"?`)) {
                fetch(`/mcp/remove?url=${encodeURIComponent(mcpUrl)}`, {
                    method: 'POST'
                })
                    .then(() => window.location.reload())
                    .catch(err => showError('Failed to remove server: ' + err.message));
            }
        }

        function setApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey || apiKey === '••••••••••••••••') {
                showError('Please enter a valid API key');
                return;
            }

            fetch('/set-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ apiKey })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('API key updated successfully!');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showError('Failed to update API key');
                    }
                })
                .catch(err => showError('Failed to update API key: ' + err.message));
        }

        function runTask() {
            const selectedCheckboxes = document.querySelectorAll('.provider-selector input[type="checkbox"]:checked');
            const mcpUrls = Array.from(selectedCheckboxes).map(cb => cb.value);
            const input = document.getElementById('taskInput').value.trim();

            if (mcpUrls.length === 0) {
                showError('Please select at least one MCP server');
                return;
            }

            if (!input) {
                showError('Please enter a task input');
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Executing...';
            button.disabled = true;

            fetch('/task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mcpUrls,
                    input
                })
            })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Unknown error');
                        });
                    }
                })
                .catch(err => {
                    showError('Failed to execute task: ' + err.message);
                    button.textContent = originalText;
                    button.disabled = false;
                });
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-4 right-4 bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-600 text-green-700 dark:text-green-300 px-4 py-3 rounded z-50';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-4 right-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 px-4 py-3 rounded z-50';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function renderUserContent() {
            const { user, providers, curlExample, hasApiKey } = window.userData;

            const datalistOptions = usefulMCPs.map(mcp =>
                `<option value="${mcp.url}">${mcp.name} - ${mcp.description}</option>`
            ).join('');

            document.getElementById('content').innerHTML = `
                <!-- Compact stats and controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-parallel-signal">${providers.length}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Connected Servers</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold ${user.verified ? 'text-green-500' : 'text-gray-400'}">${user.verified ? '✓' : '○'}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Verified Account</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 text-center md:col-span-2 lg:col-span-1">
                        <div class="text-2xl font-bold ${hasApiKey ? 'text-green-500' : 'text-gray-400'}">${hasApiKey ? '✓' : '○'}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">API Key Set</div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="text-gray-600 dark:text-gray-400">Welcome back, <strong class="text-parallel-black dark:text-parallel-off-white">${user.name}</strong> (@${user.username})</p>
                </div>
                
                <!-- Compact forms section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- API Key Form -->
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-gerstner font-medium mb-3">Parallel API Key</h3>
                        <div class="space-y-3">
                            <input 
                                type="password" 
                                id="apiKey" 
                                placeholder="Enter your Parallel API key"
                                value="${hasApiKey ? '••••••••••••••••' : ''}"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-parallel-black dark:text-parallel-off-white text-sm"
                            >
                            <button onclick="setApiKey()" class="w-full bg-parallel-signal hover:bg-orange-600 text-white px-4 py-2 rounded text-sm font-medium">
                                Update API Key
                            </button>
                            <p class="text-xs text-gray-500">Get your API key from <a href="https://parallel.ai" class="text-parallel-signal hover:underline">parallel.ai</a></p>
                        </div>
                    </div>
                    
                    <!-- Add MCP Server Form -->
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-gerstner font-medium mb-3">Add MCP Server</h3>
                        <div class="space-y-3">
                            <input 
                                type="url" 
                                id="mcpUrl" 
                                placeholder="MCP Server URL"
                                list="mcpServers"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-parallel-black dark:text-parallel-off-white text-sm"
                            >
                            <datalist id="mcpServers">
                                ${datalistOptions}
                            </datalist>
                            <button onclick="addMCPServer()" class="w-full bg-parallel-signal hover:bg-orange-600 text-white px-4 py-2 rounded text-sm font-medium">
                                Connect MCP Server
                            </button>
                            <p class="text-xs text-gray-500">Streamable HTTP only, no custom headers</p>
                        </div>
                    </div>
                </div>
                
                ${hasApiKey && providers.length > 0 ? `
                    <!-- Task Runner -->
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
                        <h3 class="font-gerstner font-medium text-lg mb-4">Execute Task with MCP Tools</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Select MCP Servers:</label>
                            <div class="provider-selector space-y-2">
                                ${providers.map(provider => `
                                    <label class="flex items-center justify-between p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded group cursor-pointer">
                                        <div class="flex items-center space-x-2">
                                            <input type="checkbox" value="${provider.mcp_url}" data-name="${provider.name}" class="accent-parallel-signal">
                                            <span class="text-sm">${provider.name}</span>
                                            <span class="text-xs text-gray-500">(${new URL(provider.mcp_url).hostname})</span>
                                        </div>
                                        <button onclick="removeMCPServer('${provider.mcp_url}')" 
                                                class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 text-xs px-2 py-1 transition-opacity">
                                            ×
                                        </button>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="taskInput" class="block text-sm font-medium mb-2">Task Input</label>
                            <textarea 
                                id="taskInput" 
                                placeholder="What would you like to do with these MCP tools?"
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-parallel-black dark:text-parallel-off-white text-sm resize-none"
                            ></textarea>
                        </div>
                        
                        <button onclick="runTask()" class="w-full bg-parallel-signal hover:bg-orange-600 text-white px-6 py-3 rounded font-medium">
                            Execute Task
                        </button>
                    </div>
                ` : ''}
                
                ${providers.length > 0 ? `
                    <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                        <h2 class="font-gerstner font-medium text-lg mb-3">Integration Examples</h2>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Use your connected MCP servers with these AI platforms:</p>
                        <pre class="bg-gray-900 dark:bg-black text-green-400 p-4 rounded text-xs overflow-x-auto border"><code>${curlExample}</code></pre>
                        <p class="text-xs text-gray-500 mt-3">Replace <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">$ANTHROPIC_API_KEY</code>, <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">$PARALLEL_API_KEY</code>, and <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">$OPENAI_API_KEY</code> with your actual API keys.</p>
                    </div>
                ` : ''}
            `;
        }

        if (window.userData) {
            renderUserContent();
            if (success) {
                showSuccess('Successfully connected to MCP server!');
            }
        }
    </script>
</body>

</html>