<!DOCTYPE html>
<html>

<head>
    <title>OAuth Connector</title>
</head>

<body>
    <h1>OAuth Connector</h1>
    <input id="host" placeholder="OAuth Server (auth.example.com)">
    <button onclick="connect()">Connect</button>
    <div id="status"></div>
    <div id="connections"></div>

    <script>
        const REDIRECT = 'https://connect.simplerauth.com';

        onload = () => { handleCallback(); renderConnections(); };

        async function connect() {
            const host = document.getElementById('host').value.trim();
            if (!host) return status('Enter hostname', 'red');

            try {
                status('Connecting...');
                const meta = await fetch(`https://${host}/.well-known/oauth-authorization-server`).then(r => r.json());
                const client = await fetch(meta.registration_endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        redirect_uris: [REDIRECT], client_name: 'OAuth Connector',
                        grant_types: ['authorization_code'], response_types: ['code']
                    })
                }).then(r => r.json());

                const state = Math.random().toString(36).substr(2);
                sessionStorage.oauth_data = JSON.stringify({ client, meta, state });
                location.href = `${meta.authorization_endpoint}?response_type=code&client_id=${client.client_id}&redirect_uri=${REDIRECT}&state=${state}&scope=openid profile`;
            } catch (e) { status('Failed: ' + e.message, 'red'); }
        }

        async function handleCallback() {
            const params = new URLSearchParams(location.search);
            const code = params.get('code'), state = params.get('state');
            if (!code) return;

            const data = JSON.parse(sessionStorage.oauth_data || '{}');
            if (state !== data.state) return status('Invalid state', 'red');

            try {
                const token = await fetch(data.meta.token_endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code', code, redirect_uri: REDIRECT, client_id: data.client.client_id
                    })
                }).then(r => r.json());

                const connections = JSON.parse(localStorage.oauth_connections || '{}');
                const hostname = new URL(data.meta.issuer).hostname;
                connections[hostname] = {
                    access_token: token.access_token, issuer: data.meta.issuer,
                    expires: token.expires_in ? Date.now() + token.expires_in * 1000 : null
                };
                localStorage.oauth_connections = JSON.stringify(connections);

                delete sessionStorage.oauth_data;
                history.replaceState({}, '', location.pathname);
                status('Connected to ' + hostname, 'green');
                renderConnections();
            } catch (e) { status('Token failed: ' + e.message, 'red'); }
        }

        function renderConnections() {
            const connections = JSON.parse(localStorage.oauth_connections || '{}');
            document.getElementById('connections').innerHTML = Object.keys(connections).length ?
                Object.entries(connections).map(([host, info]) =>
                    `<div style="border:1px solid #ddd;padding:10px;margin:10px 0">
                <h4>${host}</h4>
                <p>Expires: ${info.expires ? new Date(info.expires).toLocaleString() : 'Unknown'}</p>
                <button onclick="logout('${host}')">Logout</button>
            </div>`
                ).join('') : '<p>No connections</p>';
        }

        function logout(host) {
            const connections = JSON.parse(localStorage.oauth_connections || '{}');
            delete connections[host];
            localStorage.oauth_connections = JSON.stringify(connections);
            renderConnections();
        }

        function status(msg, color = '') {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.style.color = color;
            if (color !== 'red') setTimeout(() => el.textContent = '', 3000);
        }
    </script>
</body>

</html>